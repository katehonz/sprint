# Модули

## Core Accounting

### Компании (Companies)

Основен entity за фирми. Всяка компания има:
- ЕИК (уникален)
- ДДС номер
- Адресни данни
- Настройки (VIES валидация, AI mapping)
- Предпочитан източник на курсове (ECB)

### Сметки (Accounts)

Йерархичен сметкоплан:
- Код и наименование
- Тип (ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE)
- Клас (1-9)
- Родителска сметка
- Ниво в йерархията
- Флаг за аналитичност
- Поддръжка на количества

### Счетоводни статии (Journal Entries)

Тройна дата:
- `documentDate` - Дата на документа
- `vatDate` - Дата за ДДС
- `accountingDate` - Счетоводна дата

Валидация:
- Сума дебит = Сума кредит
- Автоматичен номер (JE-YYYYMMDD-XXXX)

Статус:
- Осчетоводена / Неосчетоводена

### Контрагенти (Counterparts)

Локални контрагенти за компания:
- ЕИК, ДДС номер
- Тип (CUSTOMER, SUPPLIER, EMPLOYEE, BANK, GOVERNMENT, OTHER)
- Адресни данни

## Валути (Currency)

### Валути

- Код (ISO 4217)
- Наименование (BG и EN)
- Символ
- Десетични знаци
- Флаг за базова валута

**Базова валута: EUR** (от 2025 г.)

### Валутни курсове

- От/Към валута
- Курс и обратен курс
- Дата на валидност
- Източник (ECB, MANUAL, API)

**Фиксиран курс BGN/EUR: 1.95583**

## Banking

### Банкови профили

Конфигурация за импорт:
- IBAN
- Сметка за банка
- Буферна сметка
- Формат на импорт:
  - UNICREDIT_MT940
  - WISE_CAMT053
  - REVOLUT_CAMT053
  - PAYSERA_CAMT053
  - POSTBANK_XML
  - OBB_XML
  - CCB_CSV

### Банкови импорти

Обработка на банкови извлечения:
- Файл (S3 key)
- Брой транзакции
- Общ дебит/кредит
- Създадени статии
- Статус (IN_PROGRESS, COMPLETED, FAILED)

## ДДС (VAT)

### ДДС ставки

- Код и наименование
- Процент
- Посока (INPUT, OUTPUT, BOTH)
- Период на валидност

Стандартни ставки:
- 20% - Стандартна
- 9% - Намалена (хотели, туризъм)
- 0% - Нулева (износ, ВОД)

### ДДС декларации

Справка-декларация по ЗДДС:
- Период (година, месец)
- Начислен ДДС (продажби)
- Данъчен кредит (покупки)
- ДДС за внасяне/възстановяване
- Разбивка по ставки
- Статус (DRAFT, CALCULATED, SUBMITTED, ACCEPTED, REJECTED)

## Дълготрайни активи (Fixed Assets)

### Категории

По ЗКПО, данъчни категории:
1. Компютри - до 50%
2. Автомобили - до 25%
3. Машини - до 15%
4. Сгради - до 4%
5. Други ДМА - до 15%
6. Нематериални - до 33.33%
7. Права - до 15%

### Активи

- Инвентарен номер (уникален)
- Придобивна стойност
- Дати (придобиване, въвеждане)
- Счетоводна амортизация (линеен метод)
- Данъчна амортизация (по ЗКПО)
- Балансова стойност (счетоводна и данъчна)
- Статус (ACTIVE, DISPOSED)

### Амортизации

`calculateDepreciation(companyId, toDate)`:
- Изчислява месечна счетоводна амортизация
- Изчислява годишна данъчна амортизация
- Актуализира балансови стойности

## Складово (Inventory)

### Наличности

Текущо състояние по сметка:
- Количество
- Стойност
- Средна цена

### Движения

Автоматично при осчетоводяване:
- Тип (IN, OUT, TRANSFER)
- Количество, единична цена
- Наличност след движението
- Средна цена към момента

**Метод: Средна претеглена цена**

## Производство (Production)

### Технологични карти

Рецепти за производство:
- Код и наименование
- Изходна сметка и количество
- Мерна единица
- Етапи (входни материали)

### Етапи на технологична карта

- Входна сметка (суровина/материал)
- Количество за единица продукция
- Мерна единица
- Пореден номер

### Производствени партиди

Конкретни производствени поръчки:
- Номер на партида (уникален)
- Технологична карта
- Планирано/реално количество
- Дати (старт, край)
- Статус (PLANNED, IN_PROGRESS, COMPLETED, CANCELLED)

### Етапи на партида

- Планирано количество (автоматично от тех. карта × мултипликатор)
- Реално изразходвано количество
- Статус (PENDING, IN_PROGRESS, COMPLETED, CANCELLED)
- Връзка към счетоводна статия

**Виж повече: [production.md](production.md)**

## AI Сканиране на документи (Document Scanning)

### Разпознаване на фактури

Използва Azure Document Intelligence за OCR и извличане на данни от фактури:
- Доставчик (име, ДДС номер, адрес)
- Клиент (име, ДДС номер, адрес)
- Номер и дата на фактура
- Суми (данъчна основа, ДДС, общо)

### Автоматично определяне на тип

Сравнява ДДС номера от фактурата с ДДС номера на текущата фирма:
- **PURCHASE** (Покупка) - ако фирмата е клиент
- **SALE** (Продажба) - ако фирмата е доставчик
- **UNKNOWN** - ако не може да се определи

### VIES валидация

Автоматична проверка на ДДС номера срещу EU VIES системата:
- REST API с fallback към SOAP
- Извлича име и адрес на фирмата
- Статуси: PENDING, VALID, INVALID, NOT_APPLICABLE, ERROR

### Сканирани фактури (ScannedInvoice)

Запазени сканирани фактури за обработка:
- Данни от сканирането
- VIES валидационен резултат
- Избрани счетоводни сметки:
  - Контрагент (401/411)
  - ДДС (4531/4532)
  - Разход/Приход (6xx/7xx)
- Статус: PENDING, VALIDATED, POSTED, REJECTED
- Флаг за ръчен преглед

### Компресия на изображения

За файлове над лимита се извършва автоматична компресия:
- Изображения (JPG, PNG): до 4MB, качество 85%
- PDF: render като JPEG страници с намалена резолюция

### REST Endpoint

```
POST /api/scan-invoice
Content-Type: multipart/form-data
Authorization: Bearer <jwt-token>

Parameters:
- file: Файл (PDF, JPG, PNG)
- companyId: ID на фирмата

Response: RecognizedInvoice JSON
```

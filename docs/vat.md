# ДДС документация

Документация за ДДС операциите в системата по ЗДДС (Закон за данък върху добавената стойност).

## ДДС ставки (България)

| Ставка | Описание |
|--------|----------|
| 20% | Стандартна ставка |
| 9% | Намалена (хотели, туризъм) |
| 0% | Нулева (износ, ВОД) |

## Типове документи

| Код | Тип |
|-----|-----|
| 01 | Фактура |
| 02 | Дебитно известие |
| 03 | Кредитно известие |
| 04 | Протокол по чл.117 |
| 05 | Известие към протокол по чл.117 |
| 07 | Митническа декларация |
| 08 | Дебитно известие към МД |
| 09 | Кредитно известие към МД |
| 11 | Фактура - Loss |
| 12 | Дебитно известие - Loss |
| 13 | Кредитно известие - Loss |
| 81 | Отчет за продажби |
| 82 | Отчет за покупки |
| 91 | Протокол за ВОП |
| 92 | Протокол за услуга от ЕС |
| 93 | Протокол за тристранна операция |
| 94 | Протокол по чл.151в |
| 95 | Документ по чл.112 |

## ДДС операции за покупки

За дневник покупки:

| Код | Клетка | Описание |
|-----|--------|----------|
| пок09 | кл.09 | ВОП стоки |
| пок10 | кл.10 | ВОП 3-странни операции |
| пок12 | кл.12 | Услуги от ЕС (чл.82) |
| пок14 | кл.14 | Внос по чл.56 |
| пок15 | кл.15 | Стоки с монтаж по чл.13 |
| пок20 | кл.20 | Данъчна основа |
| пок30 | кл.30 | Покупки с ДК 20% |
| пок31 | кл.31 | ДДС с ДК 20% |
| пок32 | кл.32 | Покупки с ДК 9% |
| пок33 | кл.33 | ДДС с ДК 9% |
| пок40 | кл.40 | Без право на ДК |
| пок41 | кл.41 | ДДС без право на ДК |

## ДДС операции за продажби

За дневник продажби:

| Код | Клетка | Описание |
|-----|--------|----------|
| про11 | кл.11 | ДО 20% |
| про12 | кл.12 | ДО 9% |
| про13 | кл.13 | ДО 0% |
| про14 | кл.14 | Услуги по чл.21 |
| про15 | кл.15 | Износ |
| про16 | кл.16 | ВОД |
| про17 | кл.17 | 3-странни ВОД |
| про18 | кл.18 | Дистанционни продажби |
| про19 | кл.19 | Освободени доставки |
| про20 | кл.20 | Начислен ДДС 20% |
| про21 | кл.21 | Начислен ДДС 9% |
| про23 | кл.23 | Лични нужди |
| про24 | кл.24 | Режим марж |
| про25 | кл.25 | Туристически услуги |

## Тройна дата

Всяка ДДС операция има три дати:

1. **Дата на документ** - датата на фактурата
2. **Дата за ДДС** - датата за ДДС дневниците (определя периода)
3. **Счетоводна дата** - датата на осчетоводяване

## Срокове

- Справка-декларация: до 14-то число на месеца, следващ данъчния период
- Дневници: заедно със справка-декларацията
- VIES декларация: до 14-то число (при ВОД)

## Еврозона

От 2025 г. България влиза в еврозоната:

- Базова валута: EUR
- Фиксиран курс BGN/EUR: 1.95583
- Курсове само от ЕЦБ

## Експорт на ДДС файлове

### TXT формат (за НАП)

Системата генерира файлове в официален формат за подаване към НАП:

| Файл | Описание | Encoding |
|------|----------|----------|
| DEKLAR.TXT | Справка-декларация по ЗДДС | Windows-1251 |
| POKUPKI.TXT | Дневник за покупки | Windows-1251 |
| PRODAGBI.TXT | Дневник за продажби | Windows-1251 |

### PDF формат (за преглед)

PDF дневниците се генерират с динамични колони - показват се само колоните с ненулеви стойности.

#### Дневник за покупки (PDF)

Колони:
- **кл. 1** - № по ред
- **кл. 3** - Вид документ (01=фактура, 02=ДИ, 03=КИ и т.н.)
- **кл. 4** - Документ номер
- **кл. 5** - Дата
- **кл. 6** - Номер на контрагент (ДДС номер или ЕИК)
- **кл. 7** - Име на контрагента (доставчик)
- **кл. 8** - Вид на стоката/услугата
- **кл. 9** - ДО без право на данъчен кредит (показва се само ако има стойности)
- **кл. 10** - ДО с право на пълен данъчен кредит (показва се само ако има стойности)
- **кл. 11** - ДДС с право на пълен данъчен кредит (показва се само ако има стойности)

#### Дневник за продажби (PDF)

Колони:
- **кл. 1** - № по ред
- **кл. 3** - Вид документ
- **кл. 4** - Документ номер
- **кл. 5** - Дата
- **кл. 6** - Номер на контрагент (ДДС номер или ЕИК)
- **кл. 7** - Име на контрагента (получател)
- **кл. 8** - Вид на стоката/услугата
- **кл. 9** - Общ размер на ДО за облагане с ДДС (показва се само ако има стойности)
- **кл. 10** - Всичко начислен ДДС (показва се само ако има стойности)
- **кл. 11** - ДО на облагаеми доставки 20% (показва се само ако има стойности)
- **кл. 12** - Начислен ДДС 20% (показва се само ако има стойности)

## API Endpoints

### GraphQL Mutations (TXT експорт)

```graphql
# Експорт на DEKLAR.TXT
mutation { exportDeklar(id: "1") }

# Експорт на POKUPKI.TXT
mutation { exportPokupki(id: "1") }

# Експорт на PRODAGBI.TXT
mutation { exportProdajbi(id: "1") }
```

### REST Endpoints (PDF експорт)

```
GET /api/vat/pokupki-pdf/{returnId}
GET /api/vat/prodajbi-pdf/{returnId}
```

Връщат PDF файл като `application/pdf` с `Content-Disposition: attachment`.

## Процес на работа с ДДС декларация

1. **Създаване** - Генерира се нова декларация за избран период (година/месец)
2. **Изчисляване** - Системата сумира всички ДДС операции за периода
3. **Преглед** - Експорт на PDF дневници за проверка
4. **Експорт** - Генериране на TXT файлове за НАП
5. **Подаване** - Маркиране като подадена (промяна на статус)

### Статуси на декларация

| Статус | Описание |
|--------|----------|
| DRAFT | Чернова - може да се редактира |
| CALCULATED | Изчислена - готова за експорт |
| SUBMITTED | Подадена - изпратена към НАП |
| ACCEPTED | Приета - потвърдена от НАП |
| PAID | Платена - данъкът е внесен |

## Генериране на ZIP архив за НАП

Системата позволява генерирането на ZIP архив, съдържащ всички необходими файлове за подаване към НАП в един пакет.

1.  Отворете страницата "ДДС Декларации".
2.  Изберете вече изчислена декларация (статус `CALCULATED`) и отидете на детайлния изглед.
3.  Натиснете бутона **"Генерирай ZIP за НАП"**.
4.  Това ще свали ZIP файл, съдържащ `DEKLAR.TXT`, `POKUPKI.TXT` и `PRODAGBI.TXT`.

**Забележка:** Функционалността за `VIES.TXT` все още не е имплементирана.

## Ръчна корекция на ДДС декларация

При необходимост, системата позволява ръчна корекция на определени полета от справка-декларацията преди нейното финално генериране.

1.  Отворете страницата "ДДС Декларации".
2.  Изберете декларация в статус `DRAFT` или `CALCULATED`.
3.  В детайлния изглед ще се появи секция "Ръчно въвеждане (Декларация)".
4.  В тази секция могат да се редактират следните полета:
    *   **ДДС за внасяне (кл. 70)** - данък от кл.50, приспаднат с данъка от кл.60
    *   **ДДС за възстановяване (кл. 71)** - данък, внесен ефективно
    *   **Ефективно за внасяне (кл. 80)** - съгласно чл.92, ал.1 ЗДДС
    *   **За приспадане (кл. 81)** - съгласно чл.92, ал.3 ЗДДС
    *   **За възстановяване по чл.92 (кл. 82)** - съгласно чл.92, ал.4 ЗДДС
5.  След въвеждане на желаните стойности, натиснете бутона **"Съхрани"**, за да ги запазите. Тези стойности ще бъдат отразени във файла `DEKLAR.TXT`.

## Настройка на ТД на НАП

За коректното генериране на файловете за НАП е необходимо да се зададе кодът на компетентната Териториална дирекция на НАП.

1.  Отворете "Компании" от главното меню.
2.  Изберете компанията, която искате да редактирате.
3.  В модалния прозорец за редакция, в секцията "Представляващи лица (за ДДС декларация)", ще намерите поле **"ТД на НАП"**.
4.  Въведете кода на дирекцията (напр. `22` за София).
5.  Запазете промените.

## Техническа имплементация

### Windows-1251 кодиране за НАП файлове

НАП изисква TXT файловете да бъдат кодирани в Windows-1251. Системата реализира това по следния начин:

1. **Backend** генерира текста в UTF-8
2. **Backend** конвертира към Windows-1251 байтове
3. **Backend** Base64-кодира байтовете и ги връща като GraphQL string
4. **Frontend** декодира Base64 към суровите Windows-1251 байтове
5. **Frontend** записва байтовете директно във файла/ZIP архива

Това гарантира коректно показване на българските букви в НАП системите.

### Журнални записи с ДДС операции

За да се включи журнален запис в ДДС дневниците, той трябва да има:

- **vatDate** - дата за ДДС (определя периода)
- **vatDocumentType** - вид документ (01=фактура, 02=ДИ и т.н.)
- **vatPurchaseOperation** или **vatSalesOperation** - код на операцията
- **counterpart** - контрагент с ДДС номер или ЕИК

При експорт системата автоматично изчислява базата и ДДС от редовете на журналния запис (EntryLines).
